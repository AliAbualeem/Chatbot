<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8">
  <title>Chatbot بـ OpenRouter</title>
  <style>
    #chat {
      border: 1px solid #ccc;
      padding: 10px;
      height: 300px;
      overflow-y: auto;
      background: #f9f9f9;
    }
    .message {
      margin: 5px 0;
    }
    .user { color: blue; }
    .bot { color: green; }
    #input { width: 100%; }
  </style>
</head>
<body>
  <div id="chat"></div>
  <textarea id="input" placeholder="اكتب رسالتك هنا"></textarea>
  <button id="send">إرسال</button>

  <script>
    const API_KEY = "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";  // لا تضعه في الكود النهائي!
    const MODEL = "deepseek/deepseek-r1:free";  // نموذج مجاني يمكنك تغييره لاحقًا
    const MAX_HISTORY = 10;  // أقصى عدد من الرسائل في التاريخ نرسلها للحفاظ على الحجم
    
    let chatHistory = [];

    document.getElementById("send").addEventListener("click", () => {
      const inputEl = document.getElementById("input");
      const msg = inputEl.value.trim();
      if (!msg) return;
      appendMessage("user", msg);
      chatHistory.push({ role: "user", content: msg });
      inputEl.value = "";
      // نقتطع التاريخ إذا صار كبيرًا
      if (chatHistory.length > MAX_HISTORY * 2) {
        chatHistory = chatHistory.slice(-MAX_HISTORY * 2);
      }
      callOpenRouter(chatHistory)
        .then(reply => {
          appendMessage("bot", reply);
          chatHistory.push({ role: "user", content: reply });
        })
        .catch(err => {
          console.error(err);
          appendMessage("bot", "حدث خطأ في الاتصال أو في الاستجابة.");
        });
    });

    function appendMessage(role, text) {
      const chatEl = document.getElementById("chat");
      const div = document.createElement("div");
      div.classList.add("message");
      div.classList.add(role);
      div.textContent = (role === "user" ? "أنت: " : "بوت: ") + text;
      chatEl.appendChild(div);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    async function callOpenRouter(history) {
      const endpoint = "https://openrouter.ai/api/v1/chat/completions";
      const payload = {
        model: MODEL,
        messages: history,
        stream: false,  // يمكنك تغييره إلى true إذا أردت استخدام البث المباشر
        max_tokens: 512,
        temperature: 0.7
      };
      const resp = await fetch(endpoint, {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${API_KEY}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(payload)
      });
      if (!resp.ok) {
        const errTxt = await resp.text();
        throw new Error(`HTTP error! status: ${resp.status}, body: ${errTxt}`);
      }
      const data = await resp.json();
      if (!data.choices || data.choices.length === 0 || !data.choices[0].message) {
        throw new Error("رد غير متوقع من الخادم");
      }
      return data.choices[0].message.content;
    }
  </script>
</body>
</html>
